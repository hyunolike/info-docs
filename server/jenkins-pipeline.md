## Jenkins pipeline 문법 
- 요약
  - 파이프라인 선언
  - 섹션 `Sections`
  - `Directives`(파이프라인 configure)
### 1. 파이프라인 선언
- 파이프라인 안쪽 >> `statement` `expression` => groovy 언어
```java
pipeline {
    /* insert Declarative Pipeline here */
}
```

### 2. 섹션(`Sections`)
- 하나이상의 스탭(`Steps`) / 지시(`Directives`) 으로 구성
- `agent`: agent 선택 시 >> 젠킨스 environment가 해당 agent로 설정 ✔


|필수여부|필수|
|---------|----|
|파라미터|- `any`: 사용가능한 agent<br>- `none`: global agent는 설정되지 않음/대신 각 stage에 설정 필요<br>- `label`: 특정 label명으로 된 environment 설정<br>- `docker`: 특정 도커 이미지로 수행<br>- `dockerfile`: 도커 파일 기반으로 수행|
|위치|- `pipeline top level`(필수)<br>- `stage block`(선택)|

- `post`: 특정 스테이지 이전 혹은 이후에 실행될 condition block ✔


|필수여부|필수|
|파라미터|- `always`: 실행 끝나고나서 실행되는 step<br>- `changed`: previous run과 다른 status이면 실행되는 step<br>- `failure`: 실패하면 실행되는 step<br>- `success`: 성공하면 실행되는 step<br>- `unstable`: test fail, code violation 등일때 실행되는 step<br>- `aborted`: 강제로 중지됬을 때 실행되는 step|
|위치|- `pipeline top level`(선택)<br>- `stage block`(선택)|

```java
pipeline {
    agent any
    stages {
        stage('Example') {
            steps {
                echo 'Hello World'
            }
        }
    }
    post { 
        always { 
            echo 'I will always say Hello again!'
        }
    }
}
```


- `stages`: 스테이지의 모음 ✔


|필수여부|필수|
|---------|-----|
|위치|- `pipeline block` 에서 단 한번|

```java
pipeline {
    agent any
    stages { 
        stage('Example') {
            steps {
                echo 'Hello World'
            }
        }
    }
}
```
- `step`: stage 내부 block에서 여러번 호출 될 수 있는 block

### 3. `Directives`(파이프라인 configure)
- `environment`: 키, 값 스타일로 파이프라인 내부에서 사용할 변수로 선언 가능


```java
pipeline {
    agent any
    environment { 
        CC = 'clang'
    }
    stages {
        stage('Example') {
            environment { 
                AN_ACCESS_KEY = credentials('my-prefined-secret-text') 
            }
            steps {
                sh 'printenv'
            }
        }
    }
}
```
- `options`: pipeline의 옵션을 선택적으로 집어 넣을 수 있음
Available Options


buildDiscarder
- Persist artifacts and console output for the specific number of recent Pipeline runs

disableConcurrentBuilds
- Disallow concurrent executions of the Pipeline. Can be useful for preventing simultaneous accesses to shared resources, etc

overrideIndexTriggers
- Allows overriding default treatment of branch indexing triggers

skipDefaultCheckout
- Skip checking out code from source control by default in the agent directive

skipStagesAfterUnstable
- Skip stages once the build status has gone to UNSTABLE

checkoutToSubdirectory
- Perform the automatic source control checkout in a subdirectory of the workspace

timeout
- Set a timeout period for the Pipeline run, after which Jenkins should abort the Pipeline

retry
- On failure, retry the entire Pipeline the specified number of times

timestamps
- Prepend all console output generated by the Pipeline run with the time at which the line was emitted


```java
pipeline {
    agent any
    options {
        timeout(time: 1, unit: 'HOURS') 
    }
    stages {
        stage('Example') {
            steps {
                echo 'Hello World'
            }
        }
    }
}
```

## 샘플 코드
```java
pipeline {
    agent any
    tools{
        jdk "jdk8"
        gradle "gradle"
    }
    environment{
        GIT_URL = "깃 주소"
    }
    stages{
        stage('check env') {
            steps{
                echo "--------check env step--------"
                echo "global java version"
                sh "java -version"    
            }
        }
        stage('prepare') {
            steps{
                echo "--------prepare step--------"    
            }
        }
        stage('Git Checkout') {
            steps{
                echo "--------git checkout step--------"    
                checkout([$class: 'GitSCM', branches: [[name: '*/Develop']], extensions: [], userRemoteConfigs: [[credentialsId: 'root', url: GIT_URL]]])
            }
        }
        stage('Build') { 
            steps{
                echo "--------build step--------"
                echo "withEnv()..."
                sh "echo JAVA_HOME" 
                sh "java -version"
                sh "echo GRADLE_HOME"
                sh "gradle --version"
                
                echo "build..."
                sh "gradle clean bootjar"  // test 없이 create jar file
            }
        }
        stage('Copy') { 
            steps{
                echo "--------copy step--------"    
            }
        }
        stage('Deploy') { 
            steps{
                echo "--------deploy step--------"    
            }
        }
        stage('Health check') { 
            steps{
                echo "--------health check step--------"    
            }
        }   
    }
}
```

