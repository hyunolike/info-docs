## N+1 ë¬¸ì œ - (ê²°ë¡ ) JPA ë§ŒëŠ¥ì•„ë‹ˆì•¼! `QueryBuilder` í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê±° ì¶”ì²œí•´
> [ì°¸ê³ ìë£Œ](https://incheol-jung.gitbook.io/docs/q-and-a/spring/n+1) 

- ì—°ê´€ê´€ê³„ì—ì„œ ë°œìƒí•˜ëŠ” ì´ìŠˆ!
- ì„¤ì •ëœ ì—”í‹°í‹° ì¡°íšŒí•  ê²½ìš° >> ì¡°íšŒë„ë‹ˆ ë°ì´í„° ê°¯ìˆ˜ X ì—°ê´€ê´€ê³„ì˜ ì¡°íšŒ ì¿¼ë¦¬ ì¶”ê°€ ë°œìƒ ã… ,ã…  â­

### ì™œ ë°œìƒ? â­
1. jpaRepository ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ë©”ì„œë“œ ì‹¤í–‰
2. jpa ë©”ì„œë“œ ì´ë¦„ ë¶„ì„ >> JPQL ìƒì„± ë° ì‹¤í–‰
3. JPQLì€ SQLì„ ì¶”ìƒí™”í•œ ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ >> íŠ¹ì • SQL ì¢…ì† X >> ì—”í‹°í‹° ê°ì²´ì™€ í•„ë“œ ì´ë¦„ì„ ê°€ì§€ê³  ì¿¼ë¦¬!
4. `select * from Owner` ì¿¼ë¦¬ë§Œ ì‹¤í–‰
5. JPQL ì…ì¥ >> ì—°ê´€ê´€ê³„ ë°ì´í„° ë¬´ì‹œ + í•´ë‹¹ ì—”í‹°í‹° ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ì¡°íšŒ
6. ğŸ™„ (ê²°ê³¼) ì—°ê´€ëœ ì—”í‹°í‹° ë°ì´í„° í•„ìš”í•œ ê²½ìš°, FetchType ìœ¼ë¡œ ì§€ì •í•œ ì‹œì ì— ì¡°íšŒë¥¼ ë³„ë„ í˜¸ì¶œ

### ì–´ë–»ê²Œ í•´ê²°?
#### `fetch = FetchType.LAZY` ë³€ê²½ (í•´ê²° âŒ) 
- í•´ê²°ëœê²Œ ì•„ë‹˜ ã… ,ã… 
- ì—°ê´€ê´€ê³„ ë°ì´í„°ë¥¼ í”„ë¡ì‹œ ê°ì²´ë¡œ ë°”ì¸ë”© >> í•˜ì§€ë§Œ!! ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë¥¼ í”„ë¡ì‹œë§Œìœ¼ë¡œ ì‚¬ìš© X 
- âœ” N+1 ë°œìƒ ì‹œì ì„ ì—°ê´€ê´€ê³„ ë°ì´í„° ì‚¬ìš©í•˜ëŠ” ì‹œì ìœ¼ë¡œ ë¯¸ë£°ì§€, ì•„ë‹ˆë©´ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œì ì— ê°€ì ¸ì˜¤ëŠëƒì— ì°¨ì´ë§Œ ìˆëŠ”ê±° ã… ,ã… 

#### 1. `Fetch join`
```java
@Query("select o from Owner o join fetch o.cats")
List<Owner> findAllJoinFetch();
```


- ë‹¨ì 
  - `FetchType` ì‚¬ìš© ë¶ˆê°€
  - `Fetch join` ì‚¬ìš©ì‹œ ë°ì´í„° í˜¸ì¶œ ì‹œì ì— ëª¨ë“  ì—°ê´€ ê´€ê³„ì˜ ë°ì´í„° ê°€ì ¸ì˜´ - `FetchType.LAZY` ë¬´ì˜ë¯¸!
  - í˜ì´ì§• ì¿¼ë¦¬ ì‚¬ìš© ë¶ˆê°€ >> í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¬¸ ê°€ì ¸ì˜¤ë‹ˆê¹Œ í˜ì´ì§• ë‹¨ìœŒ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ê±° ë¶ˆê°€

#### 2. `EntityGraph`
```java
@EntityGraph(attributePaths = "cats")
@Query("select o from Owner o")
List<Owner> findAllEntityGraph();
```


- ì£¼ì˜í•  ì 
  - ì¹´ë°ì‹œì•ˆ ê³±? ë°œìƒí•´ Ownerì˜ ìˆ˜ë§Œí¼ Cat ì¤‘ë³µ ë°ì´í„° ì¡´ì¬ ã… ,ã…   >> ì»¬ë ‰ì…˜ ì¡´ì¬í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜
- ì¤‘ë³µ ë°ì´í„° ì œê±° ë°©ë²•
  - `Set` ìë£Œêµ¬ì¡° ì‚¬ìš©
  - `distinct` ì‚¬ìš©
#### 3. `FetchMode.SUBSELECT`
- í•œë²ˆì˜ ì¿¼ë¦¬ê°€ ì•„ë‹ˆ 2ë²ˆì˜ ì¿¼ë¦¬ë¡œ í•´ê²°



```JAVA
@Entity
@Getter
@Setter
@NoArgsConstructor
public class Owner {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String name;

    @Fetch(FetchMode.SUBSELECT)
    @OneToMany(mappedBy = "owner", fetch = FetchType.EAGER)
    private Set<Cat> cats = new LinkedHashSet<>();

}
```
#### 4. `BatchSize`
- `org.hibernate.annotations.BatchSize`


```java
@Entity
@Getter
@Setter
@NoArgsConstructor
public class Owner {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;
    private String name;

    @BatchSize(size=5)
    @OneToMany(mappedBy = "owner", fetch = FetchType.EAGER)
    private Set<Cat> cats = new LinkedHashSet<>();
}
```
#### 5. `QueryBuilder`
- Query ì§€ì› í”ŒëŸ¬ê·¸ì¸
  - `Mybatis, QueryDSL, JOOQ, JDBC Template`


```java
// QueryDSLë¡œ êµ¬í˜„í•œ ì˜ˆì œ
return from(owner).leftJoin(owner.cats, cat)
                   .fetchJoin()
```
